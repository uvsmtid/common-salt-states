<?xml version='1.0' encoding='UTF-8'?>
<project>

  {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import common_job_configuration with context %}
  {{ common_job_configuration(job_config, job_environ) }}

  <builders>

    {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import copy_artifacts with context %}
    {{ copy_artifacts(job_config, job_environ) }}

    <hudson.tasks.Shell>
      <command>

        set -e
        set -u

        {% if 'skip_script_execution' in job_config and job_config['skip_script_execution'] %}
        exit 0
        {% endif %}

        {% if 'skip_if_true' in job_config %}
        if [ "${{ '{' }}{{ job_config['skip_if_true'] }}:-false}" == "true" ]
        then
            exit 0
        fi
        {% endif %}

        # Before building bootstrap package this job needs to transfer
        # (with any necessary updates) dynamic build descriptor from
        # the source pillar repository into target pillar repository.

        # TODO: Implement
        exit 0

        # DISABLED
        {% if False %}

        #######################################################################
        # TODO: Move it to build verification job.
        # Make sure target bootstrap profile pillars repo is on required branch.

        # Get location of target bootstrap profile pillars repo.
        {% set project_name = pillar['project_name'] %}
        {% set repo_config = pillar['system_features']['deploy_environment_sources']['source_repositories'][project_name + '-salt-pillars.bootstrap-target']['git'] %}

        TARGET_BOOTSTRAP_PROFILE_PILLARS_REPO_PATH='{{ get_system_host_primary_user_posix_home(repo_config['source_system_host']) }}/{{ repo_config['origin_uri_ssh_path'] }}'
        cd "${TARGET_BOOTSTRAP_PROFILE_PILLARS_REPO_PATH}"
        git checkout ${TARGET_PROFILE_NAME}
        CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"
        cd -

        test "$CURRENT_BRANCH" == "${TARGET_PROFILE_NAME}"

        {% endif %}

      </command>
    </hudson.tasks.Shell>
  </builders>

  <publishers>

    {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import parameterized_job_triggers_macro with context %}
    {{ parameterized_job_triggers_macro(job_config, job_environ) }}

  </publishers>

  <buildWrappers/>

</project>

