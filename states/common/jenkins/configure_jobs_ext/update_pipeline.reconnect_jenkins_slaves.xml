<?xml version='1.0' encoding='UTF-8'?>
<project>

  {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import common_job_configuration with context %}
  {{ common_job_configuration(job_config, job_environ) }}

  <builders>

    {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import copy_artifacts with context %}
    {{ copy_artifacts(job_config, job_environ) }}

    <hudson.tasks.Shell>
      <command>

        {% from 'common/libs/host_config_queries.sls' import get_system_host_primary_user_posix_home with context %}

        {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import locate_dynamic_build_descriptor with context %}
        {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import update_dynamic_build_descriptor with context %}

        {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import common_build_script_header with context %}
        {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import common_build_script_footer with context %}

        #######################################################################
        # Script header

        {{ common_build_script_header(job_config, job_environ) }}

        #######################################################################

        # Use Jenkins'es CLI `disconnect-node` and `connect-node`
        # commands to reconnect to all notes (except local Jenkins
        # master which is available by default).
        # The command must be run on Jenkins master (otherwise it is
        # not clear how successful completion guarateed due to
        # disconnection with remote Jenkins slaves).

        # Disconnect and Connect all Jenkins Slaves.
        {% for node_name in pillar['system_host_roles']['jenkins_slave_role']['assigned_hosts'] %}
        {% set node_config = pillar['system_hosts'][node_name] %}

        eval "${JENKINS_CLI_TOOL_INVOKE_STRING} disconnect-node  {{ node_name }}"
        eval "${JENKINS_CLI_TOOL_INVOKE_STRING} connect-node     {{ node_name }}"
        eval "${JENKINS_CLI_TOOL_INVOKE_STRING} wait-node-online {{ node_name }}"

        {% endfor %}

        #######################################################################
        # Script footer

        {{ common_build_script_footer(job_config, job_environ) }}

        #######################################################################

      </command>
    </hudson.tasks.Shell>
  </builders>

  <publishers>

    {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import archive_artifacts with context %}
    {{ archive_artifacts(job_config, job_environ) }}

    {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import parameterized_job_triggers_macro with context %}
    {{ parameterized_job_triggers_macro(job_config, job_environ) }}

  </publishers>

  <buildWrappers/>

</project>

