<?xml version='1.0' encoding='UTF-8'?>
<project>

  {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import common_job_configuration with context %}
  {{ common_job_configuration(job_config, job_environ) }}

  <builders>

    {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import copy_artifacts with context %}
    {{ copy_artifacts(job_config, job_environ) }}

    <hudson.tasks.Shell>
      <command>

        set -e
        set -u

        {% if 'skip_script_execution' in job_config and job_config['skip_script_execution'] %}
        exit 0
        {% endif %}

        # Run `highstate` separately (not as part of `orchestrate` runner)
        # as there is no known way to ask `orchestrate` to run it
        # with test=False.
        # See: https://github.com/saltstack/salt/issues/24209
        sudo salt \
            --out json \
            '*' \
            -l debug \
            state.highstate \
            test=False | tee salt.output.json

        # Capture errors from Salt.
        # At the moment salt does not return exit/error code.
        # See: https://github.com/saltstack/salt/issues/18510
        /srv/states/bootstrap/bootstrap.dir/modules/utils/check_salt_output.py \
            salt.output.json

      </command>
    </hudson.tasks.Shell>
  </builders>

  <publishers>

    {% from 'common/jenkins/configure_jobs_ext/common_xml_templates.lib.sls' import parameterized_job_triggers_macro with context %}
    {{ parameterized_job_triggers_macro(job_config, job_environ) }}

  </publishers>

  <buildWrappers/>

</project>

